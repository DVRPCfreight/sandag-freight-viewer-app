!function(){"use strict";d3.csv("data/d3/commRegions_v2.csv",function(a){d3.csv("data/d3/totalFlowsBEA.csv",function(b){d3.csv("data/d3/commodities.csv",function(c){d3.csv("data/d3/stcc.csv",function(d){function e(a,b,d,e){for(var h=a,i=b,j=d,k=e,l=[],m=0;m<c.length;m++){var n=c[m];n.dir===j&&parseInt(n.region)===h&&n.mode.toLowerCase()===k&&l.push(n)}var o=f(l,i);g(o)}function f(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.value-a.value}),a}function g(a){function b(a){var b=j(a);"ton"===s?h.push(parseInt(a.ton)):h.push(parseInt(a.value)),g.push(b)}function c(){return d3.svg.axis().scale(u).orient("bottom").ticks(5)}function e(){return"ton"===s?"thousand tons of activity":"million dollars of activity"}function f(a){if("ton"===s)var b=numeral(n(.001*a,2)).format("0,0");else var b="$ "+numeral(n(1e-6*a,2)).format("0,0");return b}var g=[],h=[];$("#commChart").empty().html("");var i=["#312A6A","#323576","#35478A","#36559A","#2E5EA5","#396ab2","#4276c2","#5584c9","#6992cf","#7ca0d5"],j=function(a){for(var b=null,c=0;c<d.length;c++){var e=d[c];parseInt(e.stcc)===parseInt(a.stcc4)&&(b=e.name)}return b};if(a.length<10)for(var k=0;k<a.length;k++){var l=a[k];b(l)}else for(var k=0;10>k;k++){var l=a[k];b(l)}var m=document.getElementById("topCommoditiesChart").offsetWidth,o=305,p=275,q=(o-30)/h.length,r=d3.select("#commChart").attr("width",m).attr("height",o),t=d3.scale.quantize().domain([0,g.length]).range(i),u=d3.scale.linear().range([0,m-250]).domain([0,d3.max(h)]),v=d3.scale.linear().domain([0,g.length]).range([0,p]),w=d3.svg.axis().orient("left").scale(v).ticks(g.length).tickSize(0).tickFormat(function(a,b){return g[b]});r.append("g").attr("class","x axis").attr("transform","translate(220,"+p+")").call(c().tickSize(2).tickFormat(f)),r.append("g").attr("class","grid").attr("transform","translate(220,"+p+")").style("stroke-dasharray","1, 2").call(c().tickSize(-p,0,0).tickFormat(""));r.append("g").attr("transform","translate(220,0)").attr("id","yaxis").call(w).selectAll("text").attr("y",q/2);r.append("text").attr("class","x-label").attr("text-anchor","end").attr("x",m/2+110).attr("y",o-2).text(e);var x=r.append("g").attr("transform","translate(220, 0)").attr("id","bars").selectAll("rect").data(h).enter();x.append("rect").attr("transform",function(a,b){return"translate(0, "+b*q+")"}).attr("width",0).attr("height",q-2).attr("class","barTip").style("fill",function(a,b){return t(b)}).transition().delay(function(a,b){return 100*b}).duration(400).attr("width",u).attr("val",function(a,b){return a}),$(".barTip").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val");if("ton"===s)var b=numeral(n(.001*a,2)).format("0,0.0")+" ktons";else var b="$ "+numeral(n(1e-6*a,2)).format("0,0.0")+" M";return b}})}function h(a,b){return a-b}function i(a){a=a.sort(h);for(var b=[],c=0;c<a.length;c++)a[c]!==a[c-1]&&b.push(a[c]);return b}function j(b){for(var c=null,d=0;d<a.length;d++){var e=a[d];parseInt(e.id)===parseInt(b)&&(c=e)}return c}function k(a,b){for(var c=(d3.geo.albersUsa(),0);c<a.length;c++){var d=j(a[c]);if(d){var e=y([d.lon,d.lat]),f=d3.select("#metros").append("g").attr("transform","translate("+Math.round(e[0])+","+Math.round(e[1])+")").attr("r",b).attr("id","metro_"+d.id).attr("class","metro related");f.append("circle").attr("r",b);d.id}}}function l(){$(".flowBtn").attr("disabled",!1),"bucks"===v?$("#dt-county-prev").prop("disabled",!0):"philadelphia"===v?$("#dt-county-next").prop("disabled",!0):($("#dt-county-next").prop("disabled",!1),$("#dt-county-prev").prop("disabled",!1))}function m(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.val-a.val}),a}function n(a,b){return Number(Math.round(a+"e"+b)+"e-"+b)}function o(a,c,d){$(".flowBtn").attr("disabled",!0),$("#tradeList").html(""),setTimeout(l,520);for(var f=m(b,s),g=[],h=[],i=[],k=[],o=0,q=0;q<f.length;q++){var r=f[q];parseInt(r.region_id)===a&&r.rel_region_id!=r.region_id&&r.dir===c&&r.mode===t&&("ton"===s?g.push(parseInt(r.ton)):g.push(parseInt(r.val)))}var h=d3.min(g),i=d3.max(g),w=d3.scale.pow().exponent(.6).domain([h,i]).range([2,35]);if(d3.select("#metros .sel_primary").classed("prevSelection",!0),d3.selectAll("#metros .sel_related").classed("prevSelection",!0),d3.selectAll("#metros .metro").classed("sel_primary",!1).classed("sel_related",!1).classed("in",!1).classed("out",!1),$("svg circle").unbind("mouseenter mouseleave"),d3.select("#metro_"+a).attr("r",15).classed("sel_primary",!0).classed("prevSelection",!1).select("circle").attr("r",15),"all"===t)for(var q=0;q<b.length;q++)parseInt(r.region_id)===a&&r.dir===c&&r.rel_region_id!=r.region_id;for(var q=0;q<f.length;q++){var x,y,z,A,r=f[q];if("ton"===s?(x=w(r.ton),z=r.ton,A=numeral(n(.001*z,2)).format("0,0.0")+" ktons"):(x=w(r.val),z=r.val,A="$ "+numeral(n(1e-6*z,2)).format("0,0.0")+" M"),parseInt(r.region_id)===a&&r.dir===c&&r.rel_region_id!=r.region_id&&r.mode===t){var B=d3.select("#metro_"+r.rel_region_id),C=j(r.rel_region_id),D=C.familiar_name;if(z>0){var E='<li class="list-group-item"><span class="badge partner-val">'+A+"</span>"+D+"</li>";k.push(E)}B.classed("prevSelection",!1),B.classed("sel_related",!0).attr("r",x).classed(c,!0).select("circle").transition().duration(500).attr("r",x).attr("i",o).attr("val",z).attr("name",D),o++}}if(k.length>0)for(var q=0;10>q;q++){var F=k[q];$(F).appendTo("#tradeList")}else{var G=v.slice(0,1).toUpperCase()+v.slice(1,v.length),F='<li class="list-group-item"><b>'+G+" County</b> has no domestic trade using <b>"+t+" transportation.</b></li>";"air"===t&&42101===a&&(F+='<li class="list-group-item">Air transportation through Philadelphia International Airport is captured by Delaware County.</li>'),$(F).appendTo("#tradeList")}d3.selectAll("#metros .prevSelection").classed("prevSelection",!1).attr("r",3).select("circle").transition().duration(500).attr("r",3),p(),$("svg .sel_related circle").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val"),b=this.getAttribute("name");n(a,2);return y="ton"===s?numeral(n(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(n(1e-6*a,2)).format("0,0.0")+" M","<b>"+b+"</b><br>"+y}}),d3.selectAll(".metro circle").on("mouseover",null),d3.selectAll(".metro circle").on("mouseout",null),d3.selectAll(".sel_related circle").on("mouseover",function(a){d3.select(this).classed("active",!0)}).on("mouseout",function(a){d3.select(this).classed("active",!1)}),e(u,s,c,t)}function p(){var a=d3.selectAll("#metros .metro")[0];q.elements(a).start()}var q=sm.packer(),r="in",s="ton",t="all",u=42017,v="bucks",w=d3.select("#content").append("svg").attr("width",960).attr("height",500).attr("id","tradeMap"),x=w.append("g").attr("width",960).attr("height",500).attr("id","states");w.append("g").attr("width",960).attr("height",500).attr("id","metros"),w.append("g").attr("width",960).attr("height",500).attr("id","temp");var y=d3.geo.albersUsa().scale(900).translate([480,250]),z=d3.geo.path().projection(y);d3.json("data/d3/us_states_shapes.json",function(a){x.selectAll("path").data(a.features).enter().append("path").attr("d",z).attr("class","states_outline")});for(var A=[],B=[],C=0;C<b.length;C++)A.push(parseInt(b[C].region_id)),B.push(parseInt(b[C].rel_region_id));A=i(A),B=i(B);var D=i(A.concat(B));k(D,3),o(u,r),$('input[name="dir"]').change(function(){r=$(this).val();var a="in"===r?"Inbound":"Outbound";o(u,r),$("#comm-"+r).prop("checked",!0),$("#tradeDirection").html(a+' <span class="caret"></span>')}),$('input[name="county"]').change(function(){d3.selectAll("#temp text").remove(),v=this.id,u=parseInt($(this).val()),o(u,r)}),$('input[name="measure"]').change(function(){s=$(this).val();var a="ton"===s?"Volume":"Value";o(u,r,"measure"),$("#comm-"+s).prop("checked",!0),$("#tradeMeasure").html(a+' <span class="caret"></span>')}),$('input[name="mode"]').change(function(){t=$(this).val(),o(u,r,"mode")}),$('input[name="tradeMeasure"]').change(function(){s=$(this).val(),$("#radio_"+s).trigger("click")}),$('input[name="tradeDirection"]').change(function(){r=$(this).val(),$("#radio_"+r).trigger("click")}),$("#dt-county-prev").on("click",function(){var a=$("#"+v).parent().prev().children();a.trigger("click")}),$("#dt-county-next").on("click",function(){var a=$("#"+v).parent().next().children();a.trigger("click")}),$(".btn").mouseup(function(){$(this).blur()})})})})})}();