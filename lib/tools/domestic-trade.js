!function(){"use strict";d3.csv("data/d3/commRegions_v2.csv",function(a){d3.csv("data/d3/totalFlowsBEA.csv",function(b){d3.csv("data/d3/commodities.csv",function(c){d3.csv("data/d3/stcc.csv",function(d){d3.json("data/d3/us_states_shapes.json",function(e){function f(a,b,d,e){var f,i=a,j=b,k=d,l=e,m=[];for(f=0;f<c.length;f++){var n=c[f];n.dir===k&&parseInt(n.region)===i&&n.mode.toLowerCase()===l&&m.push(n)}h(g(m,j))}function g(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.value-a.value}),a}function h(a){function b(a){var b=k(a);"ton"===w?h.push(parseInt(a.ton)):h.push(parseInt(a.value)),g.push(b)}function c(){return d3.svg.axis().scale(u).orient("bottom").ticks(5)}function e(){return"ton"===w?"thousand tons of activity":"million dollars of activity"}function f(a){return"ton"===w?numeral(o(.001*a,2)).format("0,0"):"$ "+numeral(o(1e-6*a,2)).format("0,0")}var g=[],h=[];$("#commChart").empty().html("");var i,j=["#312A6A","#323576","#35478A","#36559A","#2E5EA5","#396ab2","#4276c2","#5584c9","#6992cf","#7ca0d5"],k=function(a){var b,c=null;for(b=0;b<d.length;b++){var e=d[b];parseInt(e.stcc)===parseInt(a.stcc4)&&(c=e.name)}return c};if(a.length<10)for(i=0;i<a.length;i++)s=a[i],b(s);else for(i=0;i<10;i++)s=a[i],b(s);var l=$("#topCommoditiesChart").width(),m=305,n=275,p=(m-30)/h.length,q=d3.select("#commChart").attr("width",l).attr("height",m),r=d3.scale.quantize().domain([0,g.length]).range(j),u=d3.scale.linear().range([0,l-250]).domain([0,d3.max(h)]),v=d3.scale.linear().domain([0,g.length]).range([0,n]),x=d3.svg.axis().orient("left").scale(v).ticks(g.length).tickSize(0).tickFormat(function(a,b){return g[b]});q.append("g").attr("class","x axis").attr("transform","translate(220,"+n+")").call(c().tickSize(2).tickFormat(f)),q.append("g").attr("class","grid").attr("transform","translate(220,"+n+")").style("stroke-dasharray","1, 2").call(c().tickSize(-n,0,0).tickFormat(""));q.append("g").attr("transform","translate(220,0)").attr("id","yaxis").call(x).selectAll("text").attr("y",p/2);q.append("text").attr("class","x-label").attr("text-anchor","end").attr("x",l/2+110).attr("y",m-2).text(e),q.append("g").attr("transform","translate(220, 0)").attr("id","bars").selectAll("rect").data(h).enter().append("rect").attr("transform",function(a,b){return"translate(0, "+b*p+")"}).attr("width",0).attr("height",p-2).attr("class","barTip").style("fill",function(a,b){return r(b)}).transition().delay(function(a,b){return 100*b}).duration(400).attr("width",u).attr("val",function(a,b){return a}),$(".barTip").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val");return t="ton"===w?numeral(o(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(o(1e-6*a,2)).format("0,0.0")+" M"}})}function i(a,b){return a-b}function j(a){a=a.sort(i);var b,c=[];for(b=0;b<a.length;b++)a[b]!==a[b-1]&&c.push(a[b]);return c}function k(b){var c,d=null;for(c=0;c<a.length;c++){var e=a[c];parseInt(e.id)===parseInt(b)&&(d=e)}return d}function l(a,b){var c;d3.geo.albersUsa();for(c=0;c<a.length;c++){var d=k(a[c]);if(d){var e=E([d.lon,d.lat]);d3.select("#metros").append("g").attr("transform","translate("+Math.round(e[0])+","+Math.round(e[1])+")").attr("r",b).attr("id","metro_"+d.id).attr("class","metro related").append("circle").attr("r",b);d.id}}}function m(){$(".flowBtn").attr("disabled",!1),"bucks"===z?$("#dt-county-prev").prop("disabled",!0):"philadelphia"===z?$("#dt-county-next").prop("disabled",!0):($("#dt-county-next").prop("disabled",!1),$("#dt-county-prev").prop("disabled",!1))}function n(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.val-a.val}),a}function o(a,b){return Number(Math.round(a+"e"+b)+"e-"+b)}function p(a,c,d){$(".flowBtn").attr("disabled",!0),$("#tradeList").html(""),setTimeout(m,520);var e,g=n(b,w),h=[],i=[],j=[],l=[],p=0;for(e=0;e<g.length;e++){var r=g[e];parseInt(r.region_id)===a&&r.rel_region_id!=r.region_id&&r.dir===c&&r.mode===x&&("ton"===w?h.push(parseInt(r.ton)):h.push(parseInt(r.val)))}i=d3.min(h),j=d3.max(h);var s=d3.scale.pow().exponent(.6).domain([i,j]).range([2,35*L]);d3.select("#metros .sel_primary").classed("prevSelection",!0),d3.selectAll("#metros .sel_related").classed("prevSelection",!0),d3.selectAll("#metros .metro").classed("sel_primary",!1).classed("sel_related",!1).classed("in",!1).classed("out",!1),$("svg circle").unbind("mouseenter mouseleave"),d3.select("#metro_"+a).attr("r",15).classed("sel_primary",!0).classed("prevSelection",!1).select("circle").attr("r",15);var t;for(t=0;t<g.length;t++){var u,v,A,B,C=g[t];if("ton"===w?(u=s(C.ton),A=C.ton,B=numeral(o(.001*A,2)).format("0,0.0")+" ktons"):(u=s(C.val),A=C.val,B="$ "+numeral(o(1e-6*A,2)).format("0,0.0")+" M"),parseInt(C.region_id)===a&&C.dir===c&&C.rel_region_id!=C.region_id&&C.mode===x){var D=d3.select("#metro_"+C.rel_region_id),E=k(C.rel_region_id),F=E.id,G=E.familiar_name;if(A>0){var H="<li class='list-group-item' data-id='"+F+"'><span class='badge partner-val'>"+B+"</span>"+G+"</li>";l.push(H)}D.classed("prevSelection",!1),D.classed("sel_related",!0).attr("r",u).classed(c,!0).select("circle").transition().duration(500).attr("r",u).attr("i",p).attr("val",A).attr("name",G),p++}}var I;if(l.length>0)for(P=0;P<10;P++)I=l[P],$(I).appendTo("#tradeList");else{I="<li class='list-group-item'><b>"+(z.slice(0,1).toUpperCase()+z.slice(1,z.length))+" County</b> has no domestic trade using <b>"+x+" transportation.</b></li>","air"===x&&42101===a&&(I+="<li class='list-group-item'>Air transportation through Philadelphia International Airport is captured by Delaware County.</li>"),$(I).appendTo("#tradeList")}d3.selectAll("#metros .prevSelection").classed("prevSelection",!1).attr("r",3).select("circle").transition().duration(500).attr("r",3),q(),$("svg .sel_related circle").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val"),b=this.getAttribute("name");o(a,2);return v="ton"===w?numeral(o(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(o(1e-6*a,2)).format("0,0.0")+" M","<b>"+b+"</b><br>"+v}}),d3.selectAll(".metro circle").on("mouseover",null),d3.selectAll(".metro circle").on("mouseout",null),d3.selectAll(".sel_related circle").on("mouseover",function(a){d3.select(this).classed("active",!0)}).on("mouseout",function(a){d3.select(this).classed("active",!1)}),f(y,w,c,x)}function q(){var a=d3.selectAll("#metros .metro")[0];u.elements(a).start()}function r(){f(y,w,v,x)}var s,t,u=sm.packer(),v="in",w="ton",x="all",y=42017,z="bucks",A=$("#content").width(),B=d3.select("#content").append("svg").attr("width",A).attr("height",430).attr("id","tradeMap"),C=B.append("g").attr("width",A).attr("height",430).attr("id","states");B.append("g").attr("width",A).attr("height",430).attr("id","metros"),B.append("g").attr("width",A).attr("height",430).attr("id","temp");var D,E=d3.geo.albersUsa().scale(900).translate([A,215]),F=d3.geo.path().projection(E),G=F.bounds(e),H=(G[1][0]-G[0][0]-15)/(A-50),I=(G[1][1]-G[0][1])/430,J=H>I?900/H:900,K=H>I?H:1,L=K>1?1/K:1;D=1/K*(G[1][0]-G[0][0])/2;var M=[D,215];E.scale(J).translate(M),C.selectAll("path").data(e.features).enter().append("path").attr("d",F).attr("class","states_outline");for(var N=[],O=[],P=0;P<b.length;P++)N.push(parseInt(b[P].region_id)),O.push(parseInt(b[P].rel_region_id));N=j(N),O=j(O),l(j(N.concat(O)),3),p(y,v),$("input[name='dir']").change(function(){v=$(this).val();var a="in"===v?"Inbound":"Outbound";p(y,v),$("#comm-"+v).prop("checked",!0),$("#tradeDirection").html(a+" <span class='caret'></span>")}),$("input[name='county']").change(function(){d3.selectAll("#temp text").remove(),z=this.id,y=parseInt($(this).val()),p(y,v)}),$("input[name='measure']").change(function(){w=$(this).val();var a="ton"===w?"Volume":"Value";p(y,v,"measure"),$("#comm-"+w).prop("checked",!0),$("#tradeMeasure").html(a+" <span class='caret'></span>")}),$("input[name='mode']").change(function(){x=$(this).val(),p(y,v,"mode")}),$("input[name='tradeMeasure']").change(function(){w=$(this).val(),$("#radio_"+w).trigger("click")}),$("input[name='tradeDirection']").change(function(){v=$(this).val(),$("#radio_"+v).trigger("click")}),$("#dt-county-prev").on("click",function(){$("#"+z).parent().prev().children().trigger("click")}),$("#dt-county-next").on("click",function(){$("#"+z).parent().next().children().trigger("click")}),$(".btn").mouseup(function(){$(this).blur()}),$(document.body).on("mouseover","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!0)}),$(document.body).on("mouseout","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!1)}),$(window).bind("resize",function(){r()})})})})})})}();